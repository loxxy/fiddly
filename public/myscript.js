!function(){"use strict";function e(e){var t,n,o,a,i,r=document.getElementsByTagName("*");for(a=[];e&&1===e.nodeType;e=e.parentNode)if(e.hasAttribute("id")){for(i=0,n=0;n<r.length&&(r[n].hasAttribute("id")&&r[n].id===e.id&&(i+=1),!(i>1));n+=1);if(1==+i)return a.unshift('id("'+e.getAttribute("id")+'")'),a.join("/");a.unshift(e.localName.toLowerCase()+'[@id="'+e.getAttribute("id")+'"]')}else if(e.hasAttribute("class"))a.unshift(e.localName.toLowerCase()+'[@class="'+e.getAttribute("class")+'"]');else{for(t=1,o=e.previousSibling;o;o=o.previousSibling)o.localName===e.localName&&(t+=1);a.unshift(e.localName.toLowerCase()+"["+t+"]")}return a.length?"/"+a.join("/"):null}function t(e){return(new XPathEvaluator).evaluate(e,document.documentElement,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}function n(e){localStorage[E]=JSON.stringify(e||k)}function o(e,t){k[e]&&k[e].push(t),n()}function a(){k=JSON.parse(localStorage[E]||"{}"),k.mv=k.mv||[],k.rm=k.rm||[],k.ed=k.ed||[]}function i(){k.rm.forEach(function(e){(e=t(e)).parentElement.removeChild(e)})}function r(e){e.preventDefault(),e.stopPropagation()}function l(t){y&&(o("rm",e(y)),$(y).remove()),B.hide(),y=null}function c(e){y&&$(y).draggable()}function s(e){y&&$(y).attr("contenteditable","true")}function d(e){var t=$(B);t.width(),t.height(),t.offset().top,$(window).scrollTop(),t.offset().left}function u(e){var t=$(e.target);y!==e.target&&(y=e.target,B.css({width:t.width()+4,height:t.height(),top:t.offset().top,left:t.offset().left-4}).show())}function f(){return C||(a(),i(),n(),C=!0),N}function g(){return x}function m(){return N?($("*").off("mouseenter.pf").filter(".ui-draggable").removeClass("ui-draggable").end().filter("*[contenteditable]").removeAttr("contenteditable"),B&&B.remove()):($("*").on("mouseenter.pf",u),B=$('<div class="fiddlyMarker"><div class="btnCon"><img class="editBtn cBtn" /><img class="moveBtn cBtn" /><img class="snapBtn cBtn" /><img class="removeBtn cBtn" /></div></div>'),B.find(".cBtn").on("mouseover",r).filter(".removeBtn").click(l).css("background-image","url('"+chrome.extension.getURL("close.png")+"')").end().filter(".moveBtn").click(c).css("background-image","url('"+chrome.extension.getURL("move.png")+"')").end().filter(".editBtn").click(s).css("background-image","url('"+chrome.extension.getURL("edit.png")+"')").end().filter(".snapBtn").click(d).css("background-image","url('"+chrome.extension.getURL("snap.png")+"')"),B.appendTo("body")),N=!N,n(),N}function p(){if(x)$(".fiddlyDownloader").remove();else{var e=$("video"),t=e.attr("src"),n=e.position()||{},o=$("<a download target='blank'>Download</a>").attr("href",t).addClass("fiddlyDownloader");o.css({position:"absolute",display:"block","z-index":"9999999",background:"white",top:n.top||0,left:n.left||0,padding:"10px",color:"#3b5998",cursor:"pointer","text-decoration":"none"}),o.insertBefore(e)}return x=!x}function h(e){var t=$("<img>").attr("src",e.image).css({width:"100%",height:"auto"}),n=$("<div>Welcome</div>").append(t).html();$.colorbox({html:n,width:"400px",height:"400px"})}function v(){return delete localStorage[E],!0}function b(e,t,n){var o=null;switch(e.method){case w.init:o=f();break;case w.initVidState:o=g();break;case w.toggleState:o=m();break;case w.toggleVidState:o=p();break;case w.loadCapture:o=h(e.data);break;case w.clearall:o=v()}n(o)}function S(e,t,n){chrome.runtime.sendMessage({data:t,method:e},n)}var w,k,B,N=!1,x=!1,C=!1,y=null,E="fiddly:data";w={init:"init",initVidState:"initVidState",clearall:"clearall",capture:"capture",loadCapture:"loadCapture",toggleState:"toggleState",toggleVidState:"toggleVidState",updateState:"updateState"},chrome.runtime.onMessage.addListener(b),$(function(){f(),S(w.updateState,N,function(e){})})}();